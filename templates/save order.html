{% extends "base.html" %}
{% block title %}Order{% endblock %}
{% block header %}
    <label>Order</label>
{% endblock %}

{% block main %}
    <div class="selector">
        <select id="tables" onchange="onSelectChange(event)">
            <option value="{{ holder }}">{{ holder }}</option>
            <option value="new">--- new ---</option>
            {% for table in tables %}
                <option value="{{ table._id }}">{{ table._id }} | {{table.bill}}$</option>
            {% endfor %}
        </select>
    </div>
    <div class="order-items-container">
        <div id="cafes" class="modal">
            <div class="modal-content">
                <span id="closeCafes" class="close">&times;</span>
                <input value="" id="cafelito" hidden>
                <label for="temperatura">Temperatura</label>
                <div class="radio-toolbar">
                    <input type="radio" name="temperatura" id="caliente" value="caliente" checked>
                    <label for="caliente">Caliente</label>
                    <input type="radio" class="option" name="temperatura" id="templada" value="templada">
                    <label for="templada">Templada</label>
                    <input type="radio" class="option" name="temperatura" id="fria" value="fria">
                    <label for="fria">Fria</label>
                </div>
                <label for="leche">Leche</label>
                <div class="radio-toolbar">
                    <input type="radio" name="leche" id="normal" value="normal" checked>
                    <label for="normal">Normal</label>
                    <input type="radio" class="option" name="leche" id="sin lactosa" value="sin lactosa">
                    <label for="sin lactosa">Sin lactosa</label>
                    <input type="radio" class="option" name="leche" id="soja" value="soja">
                    <label for="soja">Soja</label>
                </div>
                <label for="leche">Taza</label>
                <div class="radio-toolbar">
                    <input type="radio" name="taza" id="vaso" value="vaso" checked>
                    <label for="vaso">Vaso</label>
                    <input type="radio" class="option" name="taza" id="taza" value="taza">
                    <label for="taza">Taza</label>
                    <input type="radio" class="option" name="taza" id="grande" value="grande">
                    <label for="grande">Grande</label>
                    <input type="radio" class="option" name="taza" id="llevar" value="llevar">
                    <label for="llevar">Llevar</label>
                </div>
                <label for="azucar">Azucar</label>
                <div class="radio-toolbar">
                    <input type="radio" name="azucar" id="azucar" value="azucar" checked>
                    <label for="azucar">Azucar</label>
                    <input type="radio" class="option" name="azucar" id="sacarina" value="sacarina">
                    <label for="sacarina">Sacarina</label>
                    <input type="radio" class="option" name="azucar" id="morena" value="morena">
                    <label for="morena">Morena</label>
                </div>
                <Label>Descafeinado</Label>
                <div>
                    <label class="switch">
                        <input type="checkbox" id="desc">
                        <span class="slider round"></span>
                    </label>
                </div>
                <Label>Doble</Label>
                <div>
                    <label class="switch">
                        <input type="checkbox" id="dobl">
                        <span class="slider round"></span>
                    </label>
                </div>
                <button id="confirmar-cafe" onclick="confirmarCafe()">Confirmar</button>
            </div>
        </div>
        <div id="tostadas" class="modal">
            <div class="modal-content">
                <span id="closeTostadas" class="close">&times;</span>
                <div class="tostadas-menu">
                    <div class="order-item">
                        <button class="button-item" type="button" onclick="countClick('Aceite')">Aceite<br><span id="Aceite-count">0</button>
                        <button class="button-minus" type="button" onclick="countDown('Aceite')">-</button>
                    </div>
                    <div class="order-item">
                        <button class="button-item" type="button" onclick="countClick('Tomate')">Tomate<br><span id="Tomate-count">0</button>
                        <button class="button-minus" type="button" onclick="countDown('Tomate')">-</button>
                    </div>
                    <div class="order-item">
                        <button class="button-item" type="button" onclick="countClick('Marmelada')">Marmelada<br><span id="Marmelada-count">0</button>
                        <button class="button-minus" type="button" onclick="countDown('Marmelada')">-</button>
                    </div>
                    <div class="order-item">
                        <button class="button-item" type="button" onclick="countClick('Bikini')">Bikini<br><span id="Bikini-count">0</button>
                        <button class="button-minus" type="button" onclick="countDown('Bikini')">-</button>
                    </div>
                    <div class="order-item">
                        <button class="button-item" type="button" onclick="countClick('Queso')">Queso<br><span id="Queso-count">0</button>
                        <button class="button-minus" type="button" onclick="countDown('Queso')">-</button>
                    </div>
                    <div class="order-item">
                        <button class="button-item" type="button" onclick="countClick('Serrano')">Serrano<br><span id="Serrano-count">0</button>
                        <button class="button-minus" type="button" onclick="countDown('Serrano')">-</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="order-item">
            <button class="button-item" type="button" onclick="countClick('Porras')">Porras<br><span id="Porras-count">0</button>
            <button class="button-minus" type="button" onclick="countDown('Porras')">-</button>
        </div>
        <div class="order-item">
            <button class="button-item" type="button" onclick="countClick('Churros')">Churros<br><span id="Churros-count">0</button>
            <button class="button-minus" type="button" onclick="countDown('Churros')">-</button>
        </div>
        <div class="order-item">
            <button class="button-item" id="openModalTostadas" type="button">Tostadas</button>
        </div>
        <div class="order-item">
            <button class="button-item" id="openModalCafes" onclick="cafes_menu(this.value)" value="con leche" type="button">Con leche</button>
        </div>
        <div class="order-item">
            <button class="button-item" id="openModalCafes" onclick="cafes_menu(this.value)" value="corto" type="button">Corto</button>
        </div>
        <div class="order-item">
            <button class="button-item" id="openModalCafes" onclick="cafes_menu(this.value)" value="largo" type="button">Largo</button>
        </div>
        <div class="order-item">
            <button class="button-item" id="openModalCafes" onclick="cafes_menu(this.value)" value="cortado" type="button">Cortado</button>
        </div>
        <div class="order-item">
            <button class="button-item" id="openModalCafes" onclick="cafes_menu(this.value)" value="solo" type="button">Solo</button>
        </div>
        <div class="order-item">
            <button class="button-item" id="openModalCafes" onclick="cafes_menu(this.value)" value="americano" type="button">Americano</button>
        </div>
        {% for item in items %}
            <div class="order-item">
                <button class="button-item" type="button" onclick="countClick('{{ item._id }}')">{{ item._id }}<br><span id="{{ item._id }}-count">0</button>
                <button class="button-minus" type="button" onclick="countDown('{{ item._id }}')">-</button>
            </div>
         {% endfor %}
    </div>
    
{% endblock %}

{% block footer %}
        <p id="order"></p>
        <div id="cafesss">
            
        </div>
    </div>
    <!-- <button id="check" onclick="check()">ADD</button> -->
    <form id="foodForm" action="/create-order" enctype="multipart/form-data" method="post" onsubmit="check(event)">
        <input class="create-button" type="submit" value="CREATE">
    </form>
    <button onclick="showList()">Show list</button>
    
    <script>
        const foodCount = {};
        var cafeCount = 0;
        var myString = '';
        // Получаем элементы
        const cafes = document.getElementById('cafes');
        const openModalCafes = document.getElementById('openModalCafes');
        const closeCafes = document.getElementById('closeCafes');

        const tostadas = document.getElementById('tostadas');
        const openModalTostadas = document.getElementById('openModalTostadas');
        const closeTostadas = document.getElementById('closeTostadas');

        function showList() {
            myString = JSON.stringify(foodCount);
            alert(myString);
        }

        // Открытие модального окна
        function cafes_menu(typo){
            document.getElementById("cafelito").value = typo;
            cafes.style.display = 'block';
        }

        // Открытие модального окна
        openModalTostadas.onclick = function() {
            tostadas.style.display = 'block';
        }

        // Закрытие модального окна
        closeTostadas.onclick = function() {
            tostadas.style.display = 'none';
        }

        function reset_options() {
            var options = document.querySelectorAll('.option');
            options.forEach(function(element){element.checked = false})
            document.getElementById('caliente').checked = true;
            document.getElementById('normal').checked = true;
            document.getElementById('vaso').checked = true;
            document.getElementById('azucar').checked = true;
            document.getElementById('desc').checked = false;
            document.getElementById('dobl').checked = false;
        }

        // Закрытие модального окна
        closeCafes.onclick = function() {
            cafes.style.display = 'none';
            reset_options()
        }

        function deleteCafe(id, item) {
            cafeCount -= 1;
            document.getElementById(id).remove();
            document.getElementById("dlt-" + id).remove();
            countDown(item);
        }

        // Закрытие окна при клике вне его
        window.onclick = function(event) {
            if (event.target == cafes) {
                cafes.style.display = 'none';
                reset_options();
            }
            if (event.target == tostadas) {
                tostadas.style.display = 'none';
                reset_options();
            }
        }

        function push(but, id, tag) {
            document.getElementById(id).value += tag;
        }

        function backspace() {
            var edt2 = document.getElementById("comment");
            edt2.value = edt2.value.substring(0, edt2.value.length - 5);
        }

        let tableName = '{{ holder }}';
        function onSelectChange(event) {
            tableName = event.target.value;
        }

        
        function countClick(food) {
            if (foodCount[food]) {
                foodCount[food] += 1;
                document.getElementById(`${food}-count`).textContent = foodCount[food];
            } else {
                foodCount[food] = 1;
                document.getElementById(`${food}-count`).textContent = foodCount[food];
                }
            myString = JSON.stringify(foodCount);
            document.getElementById("order").innerHTML = myString;
            }
        function countDown(food) {
            if (foodCount[food]) {
                foodCount[food] -= 1;
                if (foodCount[food] == 0) {
                    delete foodCount[food];
                    document.getElementById(`${food}-count`).textContent = 0;
                    } else {
                        document.getElementById(`${food}-count`).textContent = foodCount[food];
                    }
                }
            myString = JSON.stringify(foodCount);
            document.getElementById("order").innerHTML = myString;
            }

        function confirmarCafe() {
            var comentario = '';
            var mark = '';
            var desc = '';
            var dobles = '';
            var cafelito = document.getElementById("cafelito").value;
            var temp = document.querySelector('input[name="temperatura"]:checked').value;
            var leche = document.querySelector('input[name="leche"]:checked').value;
            var taza = document.querySelector('input[name="taza"]:checked').value;
            var azucar = document.querySelector('input[name="azucar"]:checked').value;
            var descaf = document.getElementById("desc").checked;
            var dobl = document.getElementById("dobl").checked;
            
            if (leche == 'soja') {
                mark = ' (soja)';
            }
            switch (taza) {
                case "vaso":
                    taza = '';
                    mark = '';
                    break;
                case "taza":
                    taza = 'en taza ';
                    mark = '';
                    break;
                case "grande":
                    taza = 'en vaso grande ';
                    mark = ' (grande)';
                    break;
                case "llevar":
                    taza = 'para llevar ';
                    mark = ' (llevar)';
                    break;
            }

            if (temp =="caliente") {
                    temp = '';
                } else {
                    temp = ' ' + temp;
                }
                if (leche =="normal") {
                    leche = '';
                }
                if (azucar =="azucar") {
                    azucar = '';
                } else {
                    azucar = ' con ' + azucar;
                }
                
                if (descaf){desc="desc "}else{desc=""}
                if (dobl){dobles="doble "; mark=' (doble)'}else{dobles=""}
                
                if (foodCount['cafe' + mark] == null) {
                    foodCount['cafe' + mark] = 0;
                }
            comentario = desc + dobles + cafelito + ' ' + taza + '| ' + leche + temp + azucar + '\n';
            foodCount['cafe' + mark] += 1;
            cafeCount += 1;
            myString = JSON.stringify(foodCount);
            document.getElementById("order").innerHTML = myString;
            const ele = document.getElementById("cafesss");
            var cafeek = document.createElement("p");
            cafeek.setAttribute("id", "cafe-" + cafeCount);
            var node = document.createTextNode(comentario);
            cafeek.appendChild(node);
            ele.appendChild(cafeek);
            var dltbtn = document.createElement("button", {class:"delete-cafe"});
            var node2 = document.createTextNode("X");
            dltbtn.setAttribute("onclick", "deleteCafe('cafe-" + cafeCount + "', 'cafe" + mark + "')");
            dltbtn.setAttribute("id", "dlt-cafe-" + cafeCount);
            dltbtn.appendChild(node2);
            ele.appendChild(dltbtn);
            
            cafes.style.display = 'none';
            reset_options();
            delete mark;
        }
        
        function check(event) {
            if (tableName == 'new' || tableName == "Choose the table") {
                let name=prompt("Escribe nombre de mesa:");
                let comment=document.getElementById("comment").value;
                tableName = name;
                const checkbox = document.getElementById('takeaway');
                if (checkbox.checked) {
                    var takeaway = true;
                } else {
                    var takeaway = false;
                }
                if (name=null){
                    alert("Escribe el nombre");
                }else{
                    if (confirm(`Mesa: ${tableName} > agregar ${JSON.stringify(foodCount)}`)) {
                        let data = {
                            "table": tableName,
                            "order": foodCount,
                            "comment": comment,
                            "takeaway": takeaway
                        };
                        event.preventDefault();
                        fetch('/create-order', {
                            method: 'POST',
                            headers: {
                            'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        }).then(response => response.json());
                        window.location.replace("/");
                        } else {
                            console.log("You pressed Cancel!");
                    }
                }
            }else{
                if (confirm(`Mesa: ${tableName} > agregar ${JSON.stringify(foodCount)}`)) {
                    let data = {
                        "table": tableName,
                        "order": foodCount,
                        "comment": comment,
                        "takeaway": takeaway
                    };
                    event.preventDefault();
                    fetch('/create-order', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    }).then(response => response.json());
                    window.location.replace("/");
                    } else {
                        console.log("You pressed Cancel!");
                    }
                }
        }  
    </script>
{% endblock %}